# Story 1.1a: Development Database & Test Data

## Status
Draft

## Story

**As a** developer,
**I want** a fully configured local database with comprehensive test data,
**so that** I can develop and test features with realistic data scenarios.

## Acceptance Criteria

1. Local Supabase instance running with database migrations
2. Users and tasks tables created with proper schema and indexes
3. Row Level Security policies configured for data protection
4. Comprehensive test data fixtures covering multiple user scenarios
5. Database seeding system with reset/reload capabilities
6. Database connectivity verified from backend API

## Tasks / Subtasks

- [ ] Set up local Supabase development (AC: 1)
  - [ ] Initialize Supabase project and local development
  - [ ] Configure Supabase CLI for local instance
  - [ ] Set up local PostgreSQL instance via Supabase
  - [ ] Verify Supabase services running locally
- [ ] Create database schema (AC: 2)
  - [ ] Create database migrations for users table
  - [ ] Create database migrations for tasks table with hierarchical support
  - [ ] Add core indexes for performance (user_id, parent_task_id, etc.)
  - [ ] Verify schema matches architecture document specifications
- [ ] Configure security policies (AC: 3)
  - [ ] Set up Row Level Security policies for users table
  - [ ] Set up Row Level Security policies for tasks table
  - [ ] Configure Supabase Auth integration policies
  - [ ] Test security policies with sample queries
- [ ] Create comprehensive test data system (AC: 4, 5)
  - [ ] Create multiple test user personas with different data
  - [ ] Generate sample task hierarchies for testing
  - [ ] Add test scenarios (empty state, full data, edge cases)
  - [ ] Create database reset and reload scripts for development
- [ ] Verify database connectivity (AC: 6)
  - [ ] Test database connection from Vercel Functions
  - [ ] Create database health check endpoint
  - [ ] Verify CRUD operations work with test data
  - [ ] Test Row Level Security from API layer

## Dev Notes

### Database Schema Implementation
Implements core schema from architecture document:
```sql
-- Users table with Supabase Auth integration
users (
  id UUID PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,  -- Handled by Supabase Auth
  name VARCHAR(100),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Tasks table with hierarchical support
tasks (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id),
  parent_task_id UUID REFERENCES tasks(id),    -- Hierarchical support
  title VARCHAR(500) NOT NULL,
  description TEXT,
  due_date TIMESTAMP,                          -- Natural language parsing results
  priority INTEGER DEFAULT 0,                 -- Priority inference
  context VARCHAR(50),                         -- work/personal classification
  task_type VARCHAR(50),                       -- Template category
  status VARCHAR(20) DEFAULT 'pending',       -- pending, in_progress, completed
  breakdown_source VARCHAR(20) DEFAULT 'manual', -- manual, rule, ai
  task_level INTEGER DEFAULT 0,               -- 0=parent, 1=subtask, 2=sub-subtask
  sequence_order INTEGER DEFAULT 0,           -- Ordering within breakdown
  estimated_effort INTEGER,                   -- Minutes
  actual_effort INTEGER,                      -- Minutes
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Performance indexes
CREATE INDEX idx_tasks_user_parent ON tasks(user_id, parent_task_id);
CREATE INDEX idx_tasks_user_context_status ON tasks(user_id, context, status);
CREATE INDEX idx_tasks_due_date ON tasks(due_date);
CREATE INDEX idx_tasks_parent_sequence ON tasks(parent_task_id, sequence_order);
```

### Test Data Scenarios
Comprehensive fixtures for local development:
- **Empty User**: New user with no tasks (onboarding flow testing)
- **Light User**: User with 3-5 simple tasks (basic functionality)
- **Power User**: User with 20+ tasks including hierarchies (performance testing)
- **Edge Case User**: Tasks with special characters, long descriptions, complex hierarchies
- **Multi-Context User**: Mix of work and personal tasks for context switching

### Environment Variables
Required for database connectivity:
- SUPABASE_URL=http://localhost:54321 (local instance)
- SUPABASE_SERVICE_ROLE_KEY=local-service-role-key
- DATABASE_URL=postgresql://postgres:password@localhost:54321/postgres

### Development Commands
After completion:
```bash
supabase start       # Start local Supabase
npm run db:reset     # Reset database to clean state
npm run db:seed      # Load test data
npm run db:status    # Check database health
```

### Dependencies
Requires Story 1.1 (Core Infrastructure Setup) to be completed first.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-02 | 1.0 | Split from original Story 1.1 | Sarah (PO Agent) |

## Dev Agent Record

*This section will be populated during implementation*

## QA Results

*This section will be populated during QA review*