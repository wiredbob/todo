# Story 1.6: Intelligent Input Processing with Hierarchical Task Support

## Status
Draft

## Story

**As a** developer,
**I want** a task processing service that can parse natural language input and extract structured metadata,
**so that** the system can demonstrate intelligence from day one while being ready for AI integration.

## Acceptance Criteria

1. Service abstraction that accepts raw input and returns structured task data
2. Temporal parsing for dates, times, deadlines ("tomorrow", "next Friday", "in 2 weeks")
3. Context detection and tagging (work/personal keywords)
4. Priority level inference from language cues
5. Task type classification (planning, reviewing, calling, creating)
6. Metadata extraction stored in database (due_date, priority, context, task_type)
7. Service interface designed to accept both rule-based and AI responses
8. Database schema supports parent-child task relationships with proper foreign keys
9. Recursive query capability to retrieve full task hierarchies efficiently
10. Sub-task creation and management through the processing service
11. Task hierarchy depth limits (e.g., max 3 levels deep) for UI complexity management
12. Breakdown source tracking (manual, rule-based, AI) for future learning

## Tasks / Subtasks

- [ ] Create task processing service architecture (AC: 1, 7)
  - [ ] Design TaskBreakdownService interface with abstraction layer
  - [ ] Create service factory pattern for rule-based vs AI processing
  - [ ] Implement service plugin architecture for extensibility
  - [ ] Add standardized response format for both processing types
- [ ] Implement natural language parsing engine (AC: 2, 3, 4, 5)
  - [ ] Create temporal parsing module (dates, times, deadlines)
  - [ ] Build context detection engine (work/personal keywords)
  - [ ] Implement priority inference from urgency language
  - [ ] Add task type classification (planning, review, research, etc.)
- [ ] Build metadata extraction and storage system (AC: 6, 12)
  - [ ] Create metadata extraction service
  - [ ] Implement database storage for parsed metadata
  - [ ] Add breakdown source tracking system
  - [ ] Create validation for extracted metadata
- [ ] Implement hierarchical task support (AC: 8, 9, 10, 11)
  - [ ] Design recursive task hierarchy database queries
  - [ ] Create subtask generation algorithms
  - [ ] Implement hierarchy depth validation (max 3 levels)
  - [ ] Build parent-child relationship management
- [ ] Create rule-based task breakdown templates (AC: 7)
  - [ ] Design template matching algorithm
  - [ ] Create initial template library (15+ common patterns)
  - [ ] Implement variable substitution in templates
  - [ ] Add template success tracking and improvement
- [ ] Build processing API endpoints (AC: 1, 7)
  - [ ] Create /api/tasks/process endpoint for input processing
  - [ ] Build /api/tasks/breakdown/:id endpoint for manual breakdown
  - [ ] Add /api/tasks/templates endpoint for template management
  - [ ] Implement processing queue for complex operations
- [ ] Add learning and feedback systems (AC: 12)
  - [ ] Create user modification tracking
  - [ ] Implement breakdown quality feedback collection
  - [ ] Build template improvement algorithms
  - [ ] Add A/B testing framework for rule vs AI comparison

## Dev Notes

### Architecture Context
This story implements the **core intelligence system** preparing for the hybrid rule-based + AI approach:

- **Rule-Based Intelligence**: Zero-cost MVP with pattern matching and templates
- **AI-Ready Architecture**: Service abstraction for seamless AI integration
- **Hybrid Strategy**: Rules handle common cases, AI handles complex edge cases
- **Learning System**: Track user modifications to improve both systems

### Processing Service Architecture
```typescript
// Service abstraction from architecture document
TaskBreakdownService {
  tryRuleBasedBreakdown() → success/failure
  fallbackToAI() → optional API call
  combineResults() → final breakdown
}
```

### Database Schema Extensions
Implements the hierarchical schema from architecture:
```sql
tasks {
  -- Hierarchical support
  parent_task_id: UUID REFERENCES tasks(id),
  task_level: INTEGER DEFAULT 0,           -- 0=parent, 1=subtask, 2=sub-subtask
  sequence_order: INTEGER DEFAULT 0,       -- Logical ordering
  
  -- Intelligence tracking
  breakdown_source: VARCHAR(20) DEFAULT 'manual',  -- 'manual', 'rule', 'ai'
  task_type: VARCHAR(50),                  -- 'planning', 'research', 'review'
  
  -- Natural language parsing results
  due_date: TIMESTAMP,                     -- Extracted temporal information
  priority: INTEGER DEFAULT 0,            -- Inferred priority level
  context: VARCHAR(50),                    -- work/personal classification
  estimated_effort: INTEGER               -- Minutes for achievability scoring
}

task_templates {
  id: UUID PRIMARY KEY,
  name: VARCHAR(100),                      -- "Party Planning", "Document Review"
  task_pattern: VARCHAR(500),              -- Keywords that trigger template
  template_data: JSONB,                    -- Structured breakdown template
  usage_count: INTEGER DEFAULT 0,         -- Template popularity tracking
  success_rate: DECIMAL(3,2) DEFAULT 0.0  -- Completion effectiveness
}
```

### Service Layer Structure
```
apps/api/breakdown/
├── process.ts           # Main processing endpoint
├── templates.ts         # Template management
├── services/
│   ├── TaskBreakdownService.ts     # Main service interface
│   ├── RuleBasedProcessor.ts       # Rule-based processing
│   ├── TemplateEngine.ts           # Template matching and application
│   ├── NLPProcessor.ts             # Natural language parsing
│   └── MetadataExtractor.ts        # Metadata extraction
├── models/
│   ├── TaskTemplate.ts             # Template data models
│   └── ProcessingResult.ts         # Result interfaces
└── utils/
    ├── DateParser.ts               # Temporal parsing utilities
    ├── ContextDetector.ts          # Work/personal detection
    └── PriorityInference.ts        # Priority level detection
```

### Rule-Based Intelligence Implementation
Per architecture document specifications:
- **Pattern Recognition**: 15+ common task types with 80%+ accuracy
- **Template Library**: 20-30 smart breakdown templates covering 80% of scenarios
- **Natural Language Parsing**: Temporal elements, context, priority, task types
- **Variable Substitution**: Dynamic template filling with user input

### Template System Design
```typescript
interface TaskTemplate {
  name: string;                    // "Party Planning"
  task_pattern: string;            // "plan party|birthday|celebration"
  template_data: {
    subtasks: SubtaskTemplate[];
    variables: string[];           // ["date", "location", "guest_count"]
    conditions?: ConditionalLogic[];
  };
  usage_count: number;
  success_rate: number;
}
```

### Learning and Improvement System
- **Modification Tracking**: Store user changes to generated breakdowns
- **Template Optimization**: Improve templates based on success rates
- **Pattern Learning**: Identify new patterns from user modifications
- **A/B Testing**: Compare rule-based vs AI effectiveness

### Performance Requirements
- **Response Time**: < 2 seconds for task breakdown (PRD requirement)
- **Template Matching**: Efficient pattern matching algorithms
- **Database Queries**: Optimized recursive queries for task hierarchies
- **Caching**: In-memory template caching for performance

### Integration Points
- **Story 1.3**: TaskInput component integration
- **Story 1.4**: Task CRUD operations with hierarchy
- **Story 1.1**: Database schema and API infrastructure
- **Future Epic 2**: Enhanced rule-based intelligence
- **Future Epic 4**: AI integration layer

### Testing Standards
- **Unit Tests**: Individual processors, parsers, template engine
- **Integration Tests**: Full processing pipeline with database
- **Performance Tests**: Response time under 2 seconds
- **Accuracy Tests**: Template matching and parsing accuracy
- **Learning Tests**: Improvement algorithm effectiveness

### Error Handling and Fallbacks
- **Processing Failures**: Graceful fallback to manual task creation
- **Template Errors**: Default templates for unmatched patterns
- **Database Errors**: Transaction rollback for failed hierarchies
- **Performance Issues**: Timeout handling with partial results

### Monitoring and Analytics
- **Processing Metrics**: Success rates, response times, template usage
- **User Behavior**: Modification patterns, template preferences
- **System Performance**: Database query performance, service response times
- **Quality Metrics**: Task completion rates by breakdown type

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-02 | 1.0 | Initial story creation | Sarah (PO Agent) |

## Dev Agent Record

*This section will be populated during implementation*

## QA Results

*This section will be populated during QA review*