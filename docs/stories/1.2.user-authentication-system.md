# Story 1.2: User Authentication System

## Status
Ready for Development

## Story

**As a** user,
**I want** to securely register and login to my account,
**so that** my tasks are private and persistent across sessions.

## Acceptance Criteria

1. User registration with email/password validation
2. Secure login with JWT token generation
3. Password hashing with bcrypt or similar
4. Session management with secure token storage
5. Basic profile management (email, name)
6. Logout functionality that invalidates tokens
7. Password reset capability via email

## Tasks / Subtasks

- [x] Set up Supabase Auth integration (AC: 1, 2, 3)
  - [x] Configure Supabase Auth settings and policies
  - [x] Set up auth client in frontend shared services
  - [x] Create auth utilities for token management
  - [x] Configure email templates for registration
- [x] Create registration API and UI (AC: 1)
  - [x] Create registration Vercel Function
  - [x] Build registration form component with validation
  - [x] Add email format and password strength validation
  - [x] Handle registration errors and success states
- [x] Create login API and UI (AC: 2, 4)
  - [x] Create login Vercel Function
  - [x] Build login form component
  - [x] Implement JWT token storage in httpOnly cookies
  - [x] Create auth middleware for protected routes
- [x] Implement session management (AC: 4)
  - [x] Create auth context and hooks for React
  - [x] Set up automatic token refresh
  - [x] Handle expired token scenarios
  - [x] Create protected route wrapper components
- [x] Build profile management interface (AC: 5)
  - [x] Create profile API endpoints for read/update
  - [x] Build profile form component
  - [x] Add email change functionality with verification
  - [x] Add name update functionality
- [ ] Implement logout functionality (AC: 6)
  - [ ] Create logout API endpoint
  - [ ] Clear auth tokens and local state
  - [ ] Redirect to login page after logout
  - [ ] Handle logout from multiple tabs
- [ ] Add password reset functionality (AC: 7)
  - [ ] Create password reset API endpoints
  - [ ] Build forgot password form
  - [ ] Build password reset form with token validation
  - [ ] Configure email templates for password reset

## Dev Notes

### Architecture Context
This story implements **Supabase Auth** as specified in the architecture:

- **Authentication Service**: Supabase Auth with JWT tokens
- **Token Storage**: Secure httpOnly cookies with SameSite=strict
- **Session Management**: Automatic token refresh
- **Database Integration**: Uses existing users table with Supabase RLS

### Database Schema
Uses the users table from Story 1.1:
```sql
users {
  id: UUID PRIMARY KEY,
  email: VARCHAR(255) UNIQUE NOT NULL,
  password_hash: VARCHAR(255) NOT NULL,  -- Handled by Supabase Auth
  name: VARCHAR(100),
  created_at: TIMESTAMP DEFAULT NOW(),
  updated_at: TIMESTAMP DEFAULT NOW()
}
```

### Security Requirements
Per architecture document:
- **Password Policy**: Minimum 8 characters via Supabase
- **Token Security**: JWT in httpOnly cookies with secure flags
- **CORS Policy**: Restricted to frontend domain
- **Input Validation**: Zod schema validation on all endpoints

### Frontend Components Structure
```
apps/web/src/
├── components/
│   ├── auth/
│   │   ├── LoginForm.tsx
│   │   ├── RegisterForm.tsx
│   │   ├── ProfileForm.tsx
│   │   └── ForgotPasswordForm.tsx
├── hooks/
│   ├── useAuth.ts
│   └── useProfile.ts
├── services/
│   └── auth.ts
└── stores/
    └── authStore.ts
```

### API Endpoints Structure
```
apps/api/
├── auth/
│   ├── login.ts
│   ├── register.ts
│   ├── logout.ts
│   ├── refresh.ts
│   └── reset-password.ts
└── profile/
    ├── get.ts
    └── update.ts
```

### Testing Standards
- **Component Tests**: Login/Register form validation and submission
- **API Tests**: Authentication flows, token validation, error handling
- **Integration Tests**: End-to-end auth flow with database
- **Security Tests**: Token security, password hashing, input sanitization

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-02 | 1.0 | Initial story creation | Sarah (PO Agent) |

## Dev Agent Record

*This section will be populated during implementation*

## QA Results

*This section will be populated during QA review*